# Multi-stage build for real roamie client
FROM golang:1.24-alpine AS builder

# Install build dependencies
RUN apk add --no-cache git

WORKDIR /app

# Copy go mod files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build roamie client binary
RUN CGO_ENABLED=0 GOOS=linux go build -o roamie ./cmd/client

# Runtime image with client
FROM alpine:latest

# Install WireGuard, networking tools, and SSH server
RUN apk add --no-cache \
    wireguard-tools \
    iproute2 \
    iptables \
    curl \
    jq \
    bash \
    bind-tools \
    iputils \
    openresolv \
    ca-certificates \
    openssh-server \
    openssh-client \
    coreutils \
    autossh

# Create directories
RUN mkdir -p /etc/wireguard /root/.config/roamie-vpn /root/.ssh /root/.roamie && \
    chmod 700 /root/.ssh

# Configure SSH server
RUN ssh-keygen -A && \
    mkdir -p /var/run/sshd && \
    adduser -D -s /bin/bash testuser && \
    echo "testuser:testpass" | chpasswd && \
    mkdir -p /home/testuser/.ssh && \
    chmod 700 /home/testuser/.ssh && \
    chown -R testuser:testuser /home/testuser/.ssh

# Configure SSH daemon
# Note: We enable PermitRootLogin with publickey only (prohibit-password) for tunnel access
# The roamie client syncs tunnel keys to /root/.ssh/authorized_keys
RUN sed -i 's/#PermitRootLogin.*/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config && \
    sed -i 's/PermitRootLogin no/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config && \
    sed -i 's/#PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#Port 22/Port 22/' /etc/ssh/sshd_config

WORKDIR /root

# Copy roamie client binary from builder
COPY --from=builder /app/roamie /usr/local/bin/roamie

# Make it executable
RUN chmod +x /usr/local/bin/roamie

# Create entrypoint script
RUN echo '#!/bin/bash' > /entrypoint.sh && \
    echo '# Start SSH daemon' >> /entrypoint.sh && \
    echo '/usr/sbin/sshd -D &' >> /entrypoint.sh && \
    echo 'echo "SSH server started on port 22"' >> /entrypoint.sh && \
    echo '# Keep container running' >> /entrypoint.sh && \
    echo 'tail -f /dev/null' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Use entrypoint script
ENTRYPOINT ["/entrypoint.sh"]
