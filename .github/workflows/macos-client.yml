name: macOS Client Test

on:
  push:
    branches: [main]
    paths:
      - 'cmd/client/**'
      - 'cmd/test-tui/**'
      - 'internal/client/**'
      - 'pkg/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/macos-client.yml'
  pull_request:
    branches: [main]
    paths:
      - 'cmd/client/**'
      - 'cmd/test-tui/**'
      - 'internal/client/**'
      - 'pkg/**'
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:

jobs:
  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      # ============================================
      # Build Client Binary (before installing WireGuard)
      # ============================================
      - name: Build client for macOS
        run: |
          go build -o roamie ./cmd/client
          ./roamie --help

      - name: Build for multiple architectures
        run: |
          GOOS=darwin GOARCH=amd64 go build -o roamie-darwin-amd64 ./cmd/client
          GOOS=darwin GOARCH=arm64 go build -o roamie-darwin-arm64 ./cmd/client
          ls -la roamie-darwin-*

      - name: Build test-tui binary
        run: go build -o test-tui ./cmd/test-tui

      # ============================================
      # WireGuard Auto-Install Test (TUI)
      # ============================================
      - name: Test WireGuard detection - NOT installed
        run: |
          echo "=== Testing WireGuard detection (NOT installed) ==="

          # Verify WireGuard is NOT installed
          which wg && echo "ERROR: wg already installed!" && exit 1 || echo "✓ wg not found (expected)"
          which wg-quick && echo "ERROR: wg-quick already installed!" && exit 1 || echo "✓ wg-quick not found (expected)"

          # Run our detection tests
          echo "Running wireguard preflight tests..."
          go test -v -run TestCheckInstalled ./internal/client/wireguard/
          go test -v -run TestRunPreflight ./internal/client/wireguard/
          go test -v -run TestCanAutoInstall ./internal/client/wireguard/

          # Verify brew is available for auto-install
          which brew && echo "✓ brew available for auto-install" || echo "⚠ brew not found"

      - name: Test WireGuard auto-install via TUI
        run: |
          echo "=== Testing WireGuard auto-install ==="

          # This test will call PromptInstall() which runs 'brew install wireguard-tools'
          # Use -count=1 to disable test caching (we need actual execution)
          go test -v -count=1 -run TestAutoInstallFlow ./internal/client/wireguard/

      - name: Verify WireGuard installation
        run: |
          # Add Homebrew paths (ARM: /opt/homebrew, Intel: /usr/local)
          export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

          echo "PATH=$PATH"
          echo "Checking wg locations..."
          ls -la /opt/homebrew/bin/wg 2>/dev/null || echo "/opt/homebrew/bin/wg not found"
          ls -la /usr/local/bin/wg 2>/dev/null || echo "/usr/local/bin/wg not found"

          which wg && which wg-quick && which wireguard-go
          wg --version

      # ============================================
      # WireGuard Interface Test
      # ============================================
      - name: Test WireGuard interface creation
        run: |
          # Add Homebrew paths (ARM: /opt/homebrew, Intel: /usr/local)
          export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

          mkdir -p /tmp/wg-test
          chmod 700 /tmp/wg-test

          # Generate ephemeral keypair (never logged)
          wg genkey > /tmp/wg-test/.privkey
          wg pubkey < /tmp/wg-test/.privkey > /tmp/wg-test/.pubkey
          chmod 600 /tmp/wg-test/.privkey

          # Create config with proper permissions
          cat > /tmp/wg-test/wg0.conf << EOF
          [Interface]
          PrivateKey = $(cat /tmp/wg-test/.privkey)
          Address = 10.100.0.2/32

          [Peer]
          PublicKey = $(cat /tmp/wg-test/.pubkey)
          Endpoint = 127.0.0.1:51820
          AllowedIPs = 10.100.0.0/24
          EOF
          chmod 600 /tmp/wg-test/wg0.conf

          # Bring up interface
          sudo wg-quick up /tmp/wg-test/wg0.conf

          # Verify interface created
          ifconfig | grep -q utun || { echo "utun interface not created"; exit 1; }
          sudo wg show | grep -q "interface" || { echo "wg show failed"; exit 1; }

          # Cleanup
          sudo wg-quick down /tmp/wg-test/wg0.conf

      # ============================================
      # Client CLI Tests
      # ============================================
      - name: Test client CLI commands
        run: |
          ./roamie --help
          ./roamie auth --help || true
          ./roamie devices --help || true
          ./roamie tunnel --help || true

      # ============================================
      # Unit Tests
      # ============================================
      - name: Run unit tests
        run: go test -v -short ./cmd/client/... ./internal/client/... ./pkg/... 2>&1 || true

      # ============================================
      # SSH Preflight TUI Tests (launchd + sshd)
      # ============================================
      - name: Test SSH detection - disabled state
        run: |
          echo "=== Testing SSH detection (Remote Login disabled) ==="
          # On GitHub runners, Remote Login (SSH) is disabled by default

          # Check launchctl status
          echo "Checking launchctl for sshd..."
          launchctl list com.openssh.sshd || echo "sshd not loaded (expected)"

          # Check systemsetup status (may need sudo)
          echo "Checking systemsetup..."
          sudo systemsetup -getremotelogin || true

          # Run our detection tests (don't fail on test results, just log)
          echo "Running sshd preflight tests..."
          go test -v -run TestCheck ./internal/client/sshd/ || true
          go test -v -run TestIsRunning ./internal/client/sshd/ || true

      - name: Enable SSH (Remote Login)
        timeout-minutes: 2
        run: |
          echo "=== Enabling Remote Login (SSH) ==="
          sudo systemsetup -setremotelogin on

          # Wait for sshd to start
          sleep 3

          # Verify it's enabled
          sudo systemsetup -getremotelogin

      - name: Test SSH detection - enabled state
        run: |
          echo "=== Testing SSH detection (Remote Login enabled) ==="

          # Check launchctl status
          echo "Checking launchctl for sshd..."
          launchctl list com.openssh.sshd || echo "sshd check"

          # Check if port 22 is listening
          echo "Checking port 22..."
          nc -z 127.0.0.1 22 && echo "Port 22 is listening" || echo "Port 22 not listening"

          # Run our detection tests - SSH should be running now
          echo "Running sshd preflight tests..."
          go test -v -run TestCheck ./internal/client/sshd/
          go test -v -run TestIsRunning ./internal/client/sshd/

          # Verify IsRunning returns true
          go test -v -run TestIsRunning ./internal/client/sshd/ 2>&1 | grep -q "IsRunning: true" && echo "✓ SSH correctly detected as running" || echo "⚠ SSH detection issue"

      - name: Disable SSH (cleanup)
        if: always()
        timeout-minutes: 1
        run: |
          echo "=== Disabling Remote Login (SSH) ==="
          # Use launchctl instead of systemsetup (faster and doesn't hang)
          sudo launchctl unload -w /System/Library/LaunchDaemons/ssh.plist 2>/dev/null || true

      # ============================================
      # Cleanup
      # ============================================
      - name: Cleanup
        if: always()
        timeout-minutes: 1
        run: |
          # Add Homebrew paths (ARM: /opt/homebrew, Intel: /usr/local)
          export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"
          sudo wg-quick down /tmp/wg-test/wg0.conf 2>/dev/null || true
          rm -rf /tmp/wg-test
          # Use launchctl instead of systemsetup (doesn't hang)
          sudo launchctl unload -w /System/Library/LaunchDaemons/ssh.plist 2>/dev/null || true
