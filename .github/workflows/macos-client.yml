name: macOS Client Test

on:
  push:
    branches: [main]
    paths:
      - 'cmd/client/**'
      - 'internal/client/**'
      - 'pkg/**'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/macos-client.yml'
  pull_request:
    branches: [main]
    paths:
      - 'cmd/client/**'
      - 'internal/client/**'
      - 'pkg/**'
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:

jobs:
  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # ============================================
      # WireGuard Tools Installation
      # ============================================
      - name: Install WireGuard tools
        run: brew install wireguard-tools

      - name: Verify WireGuard installation
        run: |
          which wg && which wg-quick && which wireguard-go
          wg --version

      # ============================================
      # Build Client Binary
      # ============================================
      - name: Build client for macOS
        run: |
          go build -o roamie ./cmd/client
          ./roamie --help

      - name: Build for multiple architectures
        run: |
          GOOS=darwin GOARCH=amd64 go build -o roamie-darwin-amd64 ./cmd/client
          GOOS=darwin GOARCH=arm64 go build -o roamie-darwin-arm64 ./cmd/client
          ls -la roamie-darwin-*

      # ============================================
      # WireGuard Interface Test
      # ============================================
      - name: Test WireGuard interface creation
        run: |
          mkdir -p /tmp/wg-test
          chmod 700 /tmp/wg-test

          # Generate ephemeral keypair (never logged)
          wg genkey > /tmp/wg-test/.privkey
          wg pubkey < /tmp/wg-test/.privkey > /tmp/wg-test/.pubkey
          chmod 600 /tmp/wg-test/.privkey

          # Create config with proper permissions
          cat > /tmp/wg-test/wg0.conf << EOF
          [Interface]
          PrivateKey = $(cat /tmp/wg-test/.privkey)
          Address = 10.100.0.2/32

          [Peer]
          PublicKey = $(cat /tmp/wg-test/.pubkey)
          Endpoint = 127.0.0.1:51820
          AllowedIPs = 10.100.0.0/24
          EOF
          chmod 600 /tmp/wg-test/wg0.conf

          # Bring up interface
          sudo wg-quick up /tmp/wg-test/wg0.conf

          # Verify interface created
          ifconfig | grep -q utun || { echo "utun interface not created"; exit 1; }
          sudo wg show | grep -q "interface" || { echo "wg show failed"; exit 1; }

          # Cleanup
          sudo wg-quick down /tmp/wg-test/wg0.conf

      # ============================================
      # Client CLI Tests
      # ============================================
      - name: Test client CLI commands
        run: |
          ./roamie --help
          ./roamie auth --help || true
          ./roamie devices --help || true
          ./roamie tunnel --help || true

      # ============================================
      # Unit Tests
      # ============================================
      - name: Run unit tests
        run: go test -v -short ./cmd/client/... ./internal/client/... ./pkg/... 2>&1 || true

      # ============================================
      # Cleanup
      # ============================================
      - name: Cleanup
        if: always()
        run: |
          sudo wg-quick down /tmp/wg-test/wg0.conf 2>/dev/null || true
          rm -rf /tmp/wg-test
