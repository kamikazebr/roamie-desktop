# Roamie VPN Server - Coolify DEV Environment
# Can run alongside production without conflicts
#
# Differences from production:
# - Container names: roamie-dev-*
# - Volumes: roamie_dev_*
# - Ports: 51821 (WG), 2224 (SSH), 8082 (API)
# - Network: 10.101.0.0/16 (instead of 10.100.0.0/16)
# - WireGuard interface: wg-dev

services:
  # ============================================
  # PostgreSQL Database (DEV)
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: roamie-dev-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DEV_DB_USER}
      POSTGRES_PASSWORD: ${DEV_DB_PASSWORD}
      POSTGRES_DB: ${DEV_DB_NAME}
    volumes:
      - roamie_dev_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DEV_DB_USER} -d ${DEV_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - roamie-dev-internal

  # ============================================
  # Roamie VPN Server (DEV)
  # ============================================
  roamie-server:
    image: ghcr.io/${DEV_GITHUB_REPOSITORY:-kamikazebr/roamie-desktop}/roamie-server:${DEV_IMAGE_TAG:-latest}
    container_name: roamie-dev-server
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database
      DATABASE_URL: postgres://${DEV_DB_USER}:${DEV_DB_PASSWORD}@${DEV_DB_HOST:-postgres}:5432/${DEV_DB_NAME}?sslmode=disable

      # Server Configuration
      API_HOST: ${DEV_API_HOST}
      API_PORT: ${DEV_API_PORT}

      # Authentication
      JWT_SECRET: ${DEV_JWT_SECRET}
      JWT_EXPIRATION: ${DEV_JWT_EXPIRATION}
      AUTH_CODE_EXPIRATION: ${DEV_AUTH_CODE_EXPIRATION}

      # Email Service (Resend)
      RESEND_API_KEY: ${DEV_RESEND_API_KEY}
      FROM_EMAIL: ${DEV_FROM_EMAIL}

      # WireGuard Configuration (DEV)
      WG_INTERFACE: ${DEV_WG_INTERFACE}
      WG_PORT: ${DEV_WG_PORT}
      WG_SERVER_PUBLIC_ENDPOINT: ${DEV_WG_SERVER_PUBLIC_ENDPOINT}
      WG_BASE_NETWORK: ${DEV_WG_BASE_NETWORK}
      WG_SUBNET_SIZE: ${DEV_WG_SUBNET_SIZE}
      WG_FALLBACK_NETWORKS: ${DEV_WG_FALLBACK_NETWORKS}

      # Device Management
      MAX_DEVICES_PER_USER: ${DEV_MAX_DEVICES_PER_USER}

      # SSH Tunnel Configuration (DEV)
      TUNNEL_PORT_START: ${DEV_TUNNEL_PORT_START}
      TUNNEL_PORT_END: ${DEV_TUNNEL_PORT_END}

      # Firebase (Optional)
      FIREBASE_CREDENTIALS_PATH: ${DEV_FIREBASE_CREDENTIALS_PATH}
    volumes:
      - roamie_dev_wireguard:/etc/wireguard
    ports:
      # DEV ports - different from production
      - "${DEV_WG_PORT:-51821}:51821/udp"
      - "${DEV_SSH_TUNNEL_PORT:-2224}:2222"
      # API port - exposed for direct access (Coolify can also proxy this)
      - "${DEV_API_PORT:-8082}:${DEV_API_PORT:-8082}"
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    devices:
      - /dev/net/tun:/dev/net/tun
    networks:
      - roamie-dev-internal
      - coolify
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${DEV_API_PORT:-8082}/health"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    labels:
      - "coolify.managed=true"
      - "coolify.port=${DEV_API_PORT:-8082}"

# ============================================
# Volumes (DEV - separate from production)
# ============================================
volumes:
  roamie_dev_postgres_data:
    driver: local
  roamie_dev_wireguard:
    driver: local

# ============================================
# Networks (DEV - separate from production)
# ============================================
networks:
  roamie-dev-internal:
    driver: bridge
  coolify:
    external: true
    name: coolify
